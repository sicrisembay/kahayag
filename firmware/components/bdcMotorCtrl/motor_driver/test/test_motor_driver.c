//*****************************************************************************
// File dependencies.
//*****************************************************************************
#include "test_motor_driver.h"
#if (ENABLE_MOTOR_DRIVER_TEST != 0)
#include "freertos/FreeRTOS.h"
#include "freertos/task.h"
#include "../motor_driver.h"
#include "esp_log.h"
#include "fix16.h"

#define MOT_DRV_TEST_PRIO               (tskIDLE_PRIORITY + 1)
#define MOT_DRV_TEST_STACK_SIZE         (4096)

static const char *TAG = "motor_driver_test";

typedef struct {
    const uint32_t nEntries;
    const fix16_t maxVal;
    const fix16_t minVal;
    const fix16_t * const pTable;
} signal_table_t;

static fix16_t const sineWave[] = {
    0, 412, 824, 1235, 1647, 2059, 2470, 2881, 3293, 3704, 
    4115, 4526, 4937, 5347, 5757, 6167, 6577, 6987, 7396, 7805, 
    8214, 8622, 9030, 9438, 9845, 10252, 10659, 11065, 11470, 11876, 
    12280, 12684, 13088, 13491, 13894, 14296, 14698, 15099, 15499, 15899, 
    16298, 16697, 17095, 17492, 17888, 18284, 18679, 19073, 19467, 19860, 
    20252, 20643, 21033, 21423, 21812, 22200, 22587, 22973, 23358, 23742, 
    24125, 24508, 24889, 25270, 25649, 26027, 26405, 26781, 27157, 27531, 
    27904, 28276, 28647, 29017, 29385, 29753, 30119, 30484, 30848, 31211, 
    31572, 31932, 32291, 32649, 33005, 33361, 33714, 34067, 34418, 34768, 
    35116, 35463, 35808, 36153, 36495, 36837, 37177, 37515, 37852, 38187, 
    38521, 38853, 39184, 39514, 39841, 40167, 40492, 40815, 41136, 41456, 
    41774, 42091, 42405, 42719, 43030, 43340, 43648, 43954, 44259, 44561, 
    44862, 45162, 45459, 45755, 46049, 46341, 46631, 46920, 47206, 47491, 
    47774, 48055, 48334, 48611, 48886, 49159, 49431, 49700, 49967, 50233, 
    50496, 50758, 51017, 51275, 51530, 51784, 52035, 52284, 52531, 52777, 
    53020, 53261, 53500, 53736, 53971, 54204, 54434, 54662, 54888, 55112, 
    55334, 55553, 55771, 55986, 56199, 56410, 56618, 56824, 57028, 57230, 
    57430, 57627, 57822, 58015, 58205, 58393, 58579, 58762, 58943, 59122, 
    59299, 59473, 59645, 59814, 59981, 60146, 60308, 60468, 60626, 60781, 
    60934, 61084, 61232, 61378, 61521, 61662, 61800, 61936, 62069, 62200, 
    62328, 62454, 62578, 62699, 62818, 62934, 63047, 63159, 63267, 63373, 
    63477, 63578, 63677, 63773, 63867, 63958, 64046, 64132, 64216, 64297, 
    64375, 64451, 64524, 64595, 64663, 64729, 64792, 64853, 64911, 64966, 
    65019, 65070, 65117, 65162, 65205, 65245, 65283, 65317, 65350, 65380, 
    65407, 65431, 65453, 65473, 65489, 65504, 65515, 65524, 65531, 65535, 
    65536, 65535, 65531, 65524, 65515, 65504, 65489, 65473, 65453, 65431, 
    65407, 65380, 65350, 65317, 65283, 65245, 65205, 65162, 65117, 65070, 
    65019, 64966, 64911, 64853, 64792, 64729, 64663, 64595, 64524, 64451, 
    64375, 64297, 64216, 64132, 64046, 63958, 63867, 63773, 63677, 63578, 
    63477, 63373, 63267, 63159, 63047, 62934, 62818, 62699, 62578, 62454, 
    62328, 62200, 62069, 61936, 61800, 61662, 61521, 61378, 61232, 61084, 
    60934, 60781, 60626, 60468, 60308, 60146, 59981, 59814, 59645, 59473, 
    59299, 59122, 58943, 58762, 58579, 58393, 58205, 58015, 57822, 57627, 
    57430, 57230, 57028, 56824, 56618, 56410, 56199, 55986, 55771, 55553, 
    55334, 55112, 54888, 54662, 54434, 54204, 53971, 53736, 53500, 53261, 
    53020, 52777, 52531, 52284, 52035, 51784, 51530, 51275, 51017, 50758, 
    50496, 50233, 49967, 49700, 49431, 49159, 48886, 48611, 48334, 48055, 
    47774, 47491, 47206, 46920, 46631, 46341, 46049, 45755, 45459, 45162, 
    44862, 44561, 44259, 43954, 43648, 43340, 43030, 42719, 42405, 42091, 
    41774, 41456, 41136, 40815, 40492, 40167, 39841, 39514, 39184, 38853, 
    38521, 38187, 37852, 37515, 37177, 36837, 36495, 36153, 35808, 35463, 
    35116, 34768, 34418, 34067, 33714, 33361, 33005, 32649, 32291, 31932, 
    31572, 31211, 30848, 30484, 30119, 29753, 29385, 29017, 28647, 28276, 
    27904, 27531, 27157, 26781, 26405, 26027, 25649, 25270, 24889, 24508, 
    24125, 23742, 23358, 22973, 22587, 22200, 21812, 21423, 21033, 20643, 
    20252, 19860, 19467, 19073, 18679, 18284, 17888, 17492, 17095, 16697, 
    16298, 15899, 15499, 15099, 14698, 14296, 13894, 13491, 13088, 12684, 
    12280, 11876, 11470, 11065, 10659, 10252, 9845, 9438, 9030, 8622, 
    8214, 7805, 7396, 6987, 6577, 6167, 5757, 5347, 4937, 4526, 
    4115, 3704, 3293, 2881, 2470, 2059, 1647, 1235, 824, 412, 
    0, -412, -824, -1235, -1647, -2059, -2470, -2881, -3293, -3704, 
    -4115, -4526, -4937, -5347, -5757, -6167, -6577, -6987, -7396, -7805, 
    -8214, -8622, -9030, -9438, -9845, -10252, -10659, -11065, -11470, -11876, 
    -12280, -12684, -13088, -13491, -13894, -14296, -14698, -15099, -15499, -15899, 
    -16298, -16697, -17095, -17492, -17888, -18284, -18679, -19073, -19467, -19860, 
    -20252, -20643, -21033, -21423, -21812, -22200, -22587, -22973, -23358, -23742, 
    -24125, -24508, -24889, -25270, -25649, -26027, -26405, -26781, -27157, -27531, 
    -27904, -28276, -28647, -29017, -29385, -29753, -30119, -30484, -30848, -31211, 
    -31572, -31932, -32291, -32649, -33005, -33361, -33714, -34067, -34418, -34768, 
    -35116, -35463, -35808, -36153, -36495, -36837, -37177, -37515, -37852, -38187, 
    -38521, -38853, -39184, -39514, -39841, -40167, -40492, -40815, -41136, -41456, 
    -41774, -42091, -42405, -42719, -43030, -43340, -43648, -43954, -44259, -44561, 
    -44862, -45162, -45459, -45755, -46049, -46341, -46631, -46920, -47206, -47491, 
    -47774, -48055, -48334, -48611, -48886, -49159, -49431, -49700, -49967, -50233, 
    -50496, -50758, -51017, -51275, -51530, -51784, -52035, -52284, -52531, -52777, 
    -53020, -53261, -53500, -53736, -53971, -54204, -54434, -54662, -54888, -55112, 
    -55334, -55553, -55771, -55986, -56199, -56410, -56618, -56824, -57028, -57230, 
    -57430, -57627, -57822, -58015, -58205, -58393, -58579, -58762, -58943, -59122, 
    -59299, -59473, -59645, -59814, -59981, -60146, -60308, -60468, -60626, -60781, 
    -60934, -61084, -61232, -61378, -61521, -61662, -61800, -61936, -62069, -62200, 
    -62328, -62454, -62578, -62699, -62818, -62934, -63047, -63159, -63267, -63373, 
    -63477, -63578, -63677, -63773, -63867, -63958, -64046, -64132, -64216, -64297, 
    -64375, -64451, -64524, -64595, -64663, -64729, -64792, -64853, -64911, -64966, 
    -65019, -65070, -65117, -65162, -65205, -65245, -65283, -65317, -65350, -65380, 
    -65407, -65431, -65453, -65473, -65489, -65504, -65515, -65524, -65531, -65535, 
    -65536, -65535, -65531, -65524, -65515, -65504, -65489, -65473, -65453, -65431, 
    -65407, -65380, -65350, -65317, -65283, -65245, -65205, -65162, -65117, -65070, 
    -65019, -64966, -64911, -64853, -64792, -64729, -64663, -64595, -64524, -64451, 
    -64375, -64297, -64216, -64132, -64046, -63958, -63867, -63773, -63677, -63578, 
    -63477, -63373, -63267, -63159, -63047, -62934, -62818, -62699, -62578, -62454, 
    -62328, -62200, -62069, -61936, -61800, -61662, -61521, -61378, -61232, -61084, 
    -60934, -60781, -60626, -60468, -60308, -60146, -59981, -59814, -59645, -59473, 
    -59299, -59122, -58943, -58762, -58579, -58393, -58205, -58015, -57822, -57627, 
    -57430, -57230, -57028, -56824, -56618, -56410, -56199, -55986, -55771, -55553, 
    -55334, -55112, -54888, -54662, -54434, -54204, -53971, -53736, -53500, -53261, 
    -53020, -52777, -52531, -52284, -52035, -51784, -51530, -51275, -51017, -50758, 
    -50496, -50233, -49967, -49700, -49431, -49159, -48886, -48611, -48334, -48055, 
    -47774, -47491, -47206, -46920, -46631, -46341, -46049, -45755, -45459, -45162, 
    -44862, -44561, -44259, -43954, -43648, -43340, -43030, -42719, -42405, -42091, 
    -41774, -41456, -41136, -40815, -40492, -40167, -39841, -39514, -39184, -38853, 
    -38521, -38187, -37852, -37515, -37177, -36837, -36495, -36153, -35808, -35463, 
    -35116, -34768, -34418, -34067, -33714, -33361, -33005, -32649, -32291, -31932, 
    -31572, -31211, -30848, -30484, -30119, -29753, -29385, -29017, -28647, -28276, 
    -27904, -27531, -27157, -26781, -26405, -26027, -25649, -25270, -24889, -24508, 
    -24125, -23742, -23358, -22973, -22587, -22200, -21812, -21423, -21033, -20643, 
    -20252, -19860, -19467, -19073, -18679, -18284, -17888, -17492, -17095, -16697, 
    -16298, -15899, -15499, -15099, -14698, -14296, -13894, -13491, -13088, -12684, 
    -12280, -11876, -11470, -11065, -10659, -10252, -9845, -9438, -9030, -8622, 
    -8214, -7805, -7396, -6987, -6577, -6167, -5757, -5347, -4937, -4526, 
    -4115, -3704, -3293, -2881, -2470, -2059, -1647, -1235, -824, -412, 
};

const signal_table_t fix16_sigTable = {
    .nEntries = 1000,
    .maxVal = 65536,
    .minVal = -65536,
    .pTable = sineWave
};

static void motor_driver_test_task(void * arg)
{
    TickType_t prevWakeTime;
    motor_driver_id_t id;
    fix16_t dutyCycle;
    fix16_t current;
    uint32_t dir[MOTOR_DRIVER_MAX] = {0, 0, 0, 0};
    uint32_t sigIdx[MOTOR_DRIVER_MAX] = {0};

    ESP_LOGI(TAG, "Test Running...");

    for(id = MOTOR_DRIVER_ID_1; id < MOTOR_DRIVER_MAX; id++) {
        sigIdx[id] = 0;
    }
    prevWakeTime = xTaskGetTickCount();

    while(1) {
        vTaskDelayUntil(&prevWakeTime, CONFIG_MOTOR_SPEED_CTRL_INTERVAL);
        for(id = MOTOR_DRIVER_ID_1; id < MOTOR_DRIVER_MAX; id++) {
            if(motor_driver_get_mode(id) == MOTOR_DRIVER_MODE_EXT_PWM) {
                dutyCycle = fix16_sigTable.pTable[sigIdx[id]];
                motor_driver_set_extPwm(id, dutyCycle);
            } else if(motor_driver_get_mode(id) == MOTOR_DRIVER_MODE_CONST_CURRENT) {
                current = fix16_sigTable.pTable[sigIdx[id]]; /* 1A Max */
                motor_driver_set_current(id, current);
            } else {
                ESP_LOGE(TAG, "MOTOR_DRIVER_ID_%d Invalid Mode (%d)", id+1, motor_driver_get_mode(id));
            }
            
            sigIdx[id]++;
            if(sigIdx[id] >= fix16_sigTable.nEntries) {
                sigIdx[id] = 0;
            }
        }
    }
    vTaskDelete(NULL);
}

void test_motor_driver_init(void)
{
    ESP_LOGI(TAG, "initializing test");

    xTaskCreate(motor_driver_test_task,
                "mot_drv_test",
                MOT_DRV_TEST_STACK_SIZE,
                NULL,
                MOT_DRV_TEST_PRIO,
                NULL);
}

#endif /* #if (ENABLE_ENCODER_TEST != 0) */
